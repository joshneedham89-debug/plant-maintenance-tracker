<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Plant Maintenance Tracker</title>

  <link rel="manifest" href="manifest.json" />
  <meta name="theme-color" content="#0f5132" />

  <link rel="stylesheet" href="style.css" />
</head>

<body>
  <div class="app">

    <!-- ---------------- HEADER ---------------- -->
    <header class="top-header">
      <div class="brand">
        <img src="icons/icon-192.png" class="logo" alt="Logo">
      </div>
      <h1>Plant Maintenance Tracker</h1>
    </header>

    <!-- ---------------- DASHBOARD SCREEN ---------------- -->
    <section id="dashboardScreen" class="screen active">
      <h2 class="section-title">Dashboard</h2>

      <div class="dashboard-grid">
        <div class="card">
          <h3>Tons Run</h3>
          <div class="tons-row">
            <div class="tons-big" id="tonsDisplay">0</div>
          </div>

          <div class="row">
            <input id="tonsInput" type="number" placeholder="Enter tons">
            <button id="addTonsBtn" class="primary-btn">Update</button>
          </div>
        </div>

        <div class="card">
          <h3>Open Problems</h3>
          <div class="big-number" id="openProblemsCount">0</div>
          <button id="dashboardReportProblemBtn" class="secondary-btn full">Report a Problem</button>
        </div>

        <div class="card">
          <h3>PMs Due Today</h3>
          <div class="big-number" id="pmDueTodayCount">0</div>
          <button class="secondary-btn full nav-jump" data-screen="pmScreen">Go to PMs</button>
        </div>
      </div>
    </section>

    <!-- ---------------- MAINTENANCE SCREEN ---------------- -->
    <section id="maintenanceScreen" class="screen">
      <h2 class="section-title">Maintenance</h2>

      <div class="card">
        <div class="problems-header-row">
          <h3>Problems</h3>
          <button id="openProblemPanelBtn" class="secondary-btn">+ Report</button>
        </div>

        <div class="problem-filters">
          <button class="prob-filter active" data-filter="Open">Open</button>
          <button class="prob-filter" data-filter="In Progress">In Progress</button>
          <button class="prob-filter" data-filter="Resolved">Resolved</button>
        </div>

        <div id="problemsList" class="problems-list"></div>
      </div>

      <div id="partsList"></div>
    </section>

    <!-- ---------------- PM SCREEN ---------------- -->
    <section id="pmScreen" class="screen">
      <!-- PMs -->
      <div class="card">
        <div class="problems-header-row">
          <h3>Preventive Maintenance</h3>
          <button id="openPmPanelBtn" class="secondary-btn">+ Add PM</button>
        </div>
        <div id="pmDueCount" class="pm-due-count">0 PMs due today</div>

        <div class="pm-filters">
          <button class="pm-filter active" data-pmfilter="ALL">All</button>
          <button class="pm-filter" data-pmfilter="DUE">Due Today</button>
          <button class="pm-filter" data-pmfilter="DONE">Completed</button>
        </div>

        <div id="pmsList" class="pms-list"></div>
      </div>
    </section>

    <!-- ---------------- INVENTORY SCREEN ---------------- -->
    <section id="inventoryScreen" class="screen">
      <h2 class="section-title">Inventory</h2>
      <div id="inventoryList"></div>
    </section>

    <!-- ---------------- AC CALC SCREEN ---------------- -->
    <section id="acScreen" class="screen">
      <h2 class="section-title">AC Calc</h2>

      <div class="card">
        <label>Enter Total Tons</label>
        <input id="acTons" type="number" placeholder="0">

        <label>Asphalt %</label>
        <input id="acPercent" type="number" placeholder="0">

        <button id="acCalcBtn" class="primary-btn full">Calculate</button>

        <div id="acResult" class="ac-result"></div>
      </div>
    </section>

    <!-- ---------------- SETTINGS SCREEN ---------------- -->
    <section id="settingsScreen" class="screen">
      <h2 class="section-title">Settings</h2>

      <div class="card">
        <h3>Role (this device)</h3>
        <div class="row">
          <select id="roleSelect" class="select full">
            <option value="Ground">Ground</option>
            <option value="Maintenance">Maintenance</option>
            <option value="Supervisor">Supervisor</option>
            <option value="Admin">Admin</option>
          </select>
        </div>
        <div class="row">
          <button id="adminLoginBtn" class="secondary-btn full">Admin Login</button>
          <button id="adminLogoutBtn" class="ghost-btn full hidden">Admin Logout</button>
        </div>

        <div id="adminPanel" class="admin-panel hidden">
          <h4 class="subheading">Admin Controls</h4>

          <label>Change / Set Admin PIN</label>
          <input id="adminPinNew" type="password" inputmode="numeric" maxlength="8" placeholder="New PIN (4-8 digits)">
          <input id="adminPinConfirm" type="password" inputmode="numeric" maxlength="8" placeholder="Confirm New PIN">
          <button id="saveAdminPinBtn" class="primary-btn full">Save PIN</button>

          <label class="check-row"><input type="checkbox" id="allowRoleChangeChk" checked> Allow role changes on this device without PIN</label>
          <div class="hint">Tip: Turn this off after you set the role on each phone.</div>
        </div>
      </div>

      <div class="card">
        <button id="exportBtn" class="primary-btn full">Export Data</button>

        <!-- GOLD UPDATE: Supervisor PM compliance export -->
        <button id="exportPmComplianceBtn" class="secondary-btn full">Export PM Compliance (CSV)</button>
        <!-- END -->

        <button id="resetAllBtn" class="danger-btn full">Reset Entire App</button>
      </div>
    </section>

    <!-- ---------------- BOTTOM NAV ---------------- -->
    <nav class="bottom-nav">
      <button class="nav-btn active" data-screen="dashboardScreen">üè†<br>Home</button>
      <button class="nav-btn" data-screen="maintenanceScreen">üõ†Ô∏è<br>Maint</button>
      <button class="nav-btn" data-screen="pmScreen">‚úÖ<br>PMs</button>
      <button class="nav-btn" data-screen="inventoryScreen">üì¶<br>Inventory</button>
      <button class="nav-btn" data-screen="acScreen">üìä<br>AC Calc</button>
      <button class="nav-btn" data-screen="settingsScreen">‚öôÔ∏è<br>Settings</button>
    </nav>

  </div>

  <!-- ADD / EDIT PART PANEL -->
  <div id="partPanelOverlay" class="panel-overlay hidden">
    <div id="addPartPanel" class="slide-panel">
      <div class="slide-panel-header">
        <h3 id="partPanelTitle">Add New Part</h3>
        <button id="closePartPanel" class="close-btn">‚úñ</button>
      </div>
      <div class="slide-panel-body">
        <label>Part Name</label>
        <input id="newPartName" type="text" placeholder="ex: Bearing 2in">

        <label>Category</label>
        <select id="newPartCategory"></select>

        <label>Qty</label>
        <input id="newPartQty" type="number" min="1" value="1">

        <label>Notes</label>
        <input id="newPartNotes" type="text" placeholder="Optional notes">

        <h4 class="subheading">Photos (optional)</h4>
        <button id="addPhotoBtn" class="secondary-btn full">+ Add Photo</button>
        <input id="photoInput" type="file" accept="image/*" multiple class="file-input-hidden">
        <div id="photoPreview" class="photo-preview"></div>

        <div class="panel-footer">
          <button id="savePartBtn" class="primary-btn full">Save</button>
        </div>
      </div>
    </div>
  </div>

  <!-- COMPLETE MAINTENANCE PANEL -->
  <div id="completeOverlay" class="panel-overlay hidden">
    <div id="completePanel" class="slide-panel">
      <div class="slide-panel-header">
        <h3>Complete Maintenance</h3>
        <button id="closeCompletePanel" class="close-btn">‚úñ</button>
      </div>

      <div class="slide-panel-body">
        <label>Date</label>
        <input id="compDate" type="date">

        <label>Tons (optional)</label>
        <input id="compTons" type="number" placeholder="Optional">

        <label>Notes</label>
        <input id="compNotes" type="text" placeholder="Optional notes">

        <h4 class="subheading">Inventory Item</h4>
        <select id="compInvSelect"></select>

        <label>Quantity Used</label>
        <input id="compInvQty" type="number" min="1" value="1">

        <button id="compAddItemBtn" class="secondary-btn full">+ Add Item</button>

        <div id="compUsedList"></div>

        <h4 class="subheading">Photos (optional)</h4>
        <button id="compAddPhotoBtn" class="secondary-btn full">+ Add Photo</button>
        <input id="compPhotoInput" type="file" accept="image/*" multiple class="file-input-hidden">
        <div id="compPhotoPreview" class="photo-preview"></div>

        <div class="panel-footer">
          <button id="saveCompletionBtn" class="primary-btn full">Save Completion</button>
        </div>
      </div>
    </div>
  </div>

  <!-- PROBLEM PANEL -->
  <div id="problemPanelOverlay" class="panel-overlay hidden">
    <div id="problemPanel" class="slide-panel">
      <div class="slide-panel-header">
        <h3>Report a Problem</h3>
        <button id="closeProblemPanel" class="close-btn">‚úñ</button>
      </div>

      <div class="slide-panel-body">
        <label>Title</label>
        <input id="problemTitle" type="text" placeholder="ex: RAP belt squealing">

        <label>Category</label>
        <select id="problemCategory"></select>

        <label>Description</label>
        <input id="problemDesc" type="text" placeholder="Details / what you saw">

        <h4 class="subheading">Photos (optional)</h4>
        <button id="problemAddPhotoBtn" class="secondary-btn full">+ Add Photo</button>
        <input id="problemPhotoInput" type="file" accept="image/*" multiple class="file-input-hidden">
        <div id="problemPhotoPreview" class="photo-preview"></div>

        <div class="panel-footer">
          <button id="saveProblemBtn" class="primary-btn full">Save Problem</button>
        </div>
      </div>
    </div>
  </div>

  <!-- PROBLEM DETAIL OVERLAY -->
  <div id="problemDetailOverlay" class="panel-overlay hidden">
    <div id="problemDetailPanel" class="slide-panel">
      <div class="slide-panel-header">
        <h3 id="problemDetailTitle">Problem</h3>
        <button id="closeProblemDetail" class="close-btn">‚úñ</button>
      </div>

      <div class="slide-panel-body">
        <div id="problemDetailMeta" class="part-meta"></div>
        <div id="problemDetailStatus" class="pill"></div>
        <div id="problemDetailPhotos" class="gallery-grid"></div>

        <div class="panel-footer">
          <button id="resolveLogBtn" class="primary-btn full">Resolve & Log Maintenance</button>
          <button id="deleteProblemBtn" class="danger-btn full">Delete</button>
        </div>
      </div>
    </div>
  </div>

  <!-- PM ADD / EDIT PANEL -->
  <div id="pmPanelOverlay" class="panel-overlay hidden">
    <div id="pmPanel" class="slide-panel">
      <div class="slide-panel-header">
        <h3 id="pmPanelTitle">Add PM</h3>
        <button id="closePmPanel" class="close-btn">‚úñ</button>
      </div>

      <div class="slide-panel-body">
        <label>PM Name</label>
        <input id="pmName" type="text" placeholder="ex: Grease bearings">

        <label>Area</label>
        <select id="pmArea"></select>

        <label>Frequency</label>
        <select id="pmFrequency">
          <option value="Daily">Daily</option>
          <option value="Weekly">Weekly</option>
        </select>

        <label>Checklist (optional)</label>
        <textarea id="pmChecklistDef" class="textarea" rows="4" placeholder="One checklist item per line"></textarea>

        <h4 class="subheading">Visibility (who can see this PM)</h4>
        <div class="role-grid">
          <label class="check-row"><input type="checkbox" id="pmVisAdmin" checked> Admin</label>
          <label class="check-row"><input type="checkbox" id="pmVisSupervisor" checked> Supervisor</label>
          <label class="check-row"><input type="checkbox" id="pmVisMaintenance" checked> Maintenance</label>
          <label class="check-row"><input type="checkbox" id="pmVisGround" checked> Ground</label>
        </div>

        <label class="check-row"><input type="checkbox" id="pmDefLocked"> Lock PM definition (prevents edits)</label>

        <div class="panel-footer">
          <button id="savePmBtn" class="primary-btn full">Save PM</button>
        </div>
      </div>
    </div>
  </div>

  <!-- PM COMPLETE PANEL -->
  <div id="pmCompleteOverlay" class="panel-overlay hidden">
    <div id="pmCompletePanel" class="slide-panel">
      <div class="slide-panel-header">
        <h3 id="pmCompleteTitle">Complete PM</h3>
        <button id="closePmComplete" class="close-btn">‚úñ</button>
      </div>

      <div class="slide-panel-body">
        <label>Completion Date</label>
        <input id="pmCompDate" type="date">

        <label>Notes</label>
        <input id="pmCompNotes" type="text" placeholder="Optional notes">

        <div id="pmChecklistWrap" class="pm-checklist-wrap hidden">
          <h4 class="subheading">Checklist (required)</h4>
          <div id="pmChecklistList" class="pm-checklist-list"></div>
          <div id="pmChecklistHint" class="hint"></div>
        </div>

        <h4 class="subheading">Photos (optional)</h4>
        <button id="pmAddPhotoBtn" class="secondary-btn full">+ Add Photo</button>
        <input id="pmPhotoInput" type="file" accept="image/*" multiple class="file-input-hidden">
        <div id="pmPhotoPreview" class="photo-preview"></div>

        <div class="panel-footer">
          <button id="savePmCompletionBtn" class="primary-btn full">Save PM</button>
        </div>
      </div>

    </div>
  </div>

  <!-- PM GALLERY OVERLAY -->
  <div id="pmGalleryOverlay" class="panel-overlay hidden">
    <div id="pmGalleryPanel" class="slide-panel">
      <div class="slide-panel-header">
        <h3 id="pmGalleryTitle">PM Gallery</h3>
        <button id="closePmGallery" class="close-btn">‚úñ</button>
      </div>
      <div class="slide-panel-body">
        <div id="pmGalleryGrid" class="gallery-grid"></div>
      </div>
    </div>
  </div>

  <!-- LIGHTBOX -->
  <div id="lightboxOverlay" class="lightbox hidden">
    <button id="lightboxClose" class="lightbox-close">‚úñ</button>
    <img id="lightboxImg" alt="Photo">
    <div id="lightboxMeta" class="lightbox-meta"></div>
  </div>

  <!-- ADMIN PIN PROMPT -->
  <div id="adminPinOverlay" class="panel-overlay hidden">
    <div id="adminPinPanel" class="slide-panel">
      <div class="slide-panel-header">
        <h3>Admin PIN</h3>
        <button id="closeAdminPin" class="close-btn">‚úñ</button>
      </div>
      <div class="slide-panel-body">
        <label>Enter PIN</label>
        <input id="adminPinInput" type="password" inputmode="numeric" maxlength="8" placeholder="4-8 digits">
        <div id="adminPinMsg" class="hint"></div>
        <div class="panel-footer">
          <button id="submitAdminPinBtn" class="primary-btn full">Unlock Admin</button>
        </div>
      </div>
    </div>
  </div>

  <script src="inventory.js"></script>
  <script src="script.js"></script>
</body>
</html>
